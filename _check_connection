# Check & update statusfile
# TODO: Shall we work out a new IPC solution instead of file? => Use env var!
function update_statusfile() {
    # 1. load statusfile's content
    latest_status=" "
    [ -e $proxy_statusfile ] && latest_status=`cat $proxy_statusfile`
    # 2. Check if needs to update the file
    [ $latest_status != $1 ] && echo $1 > $proxy_statusfile
}

# Check if the connection to proxy is still available
function _check_connection() {
    # 1. Check if we are physically connecting to the proxy.
    cmd="set timeout 2; spawn telnet ${proxy_proxy_server} 22; expect \"Connection refused\" {exit 1} -re \"Escape\" {exit 0}; exit 1"
    echo $cmd
    expect -c ${cmd}
    if [ $? -ne 0 ]; then
        # Physically disconnected
        update_statusfile "Disconnected"
        return 127
    fi
    # 2. Check if the proxy's connected
    netstat -an | grep "${proxy_proxy_server}\.22.*ESTABLISHED"
    if [ $? -ne 0 ]; then
        update_statusfile "Disconnected"
        return 1
    fi

    update_statusfile "Connected"
    return 0 
}
